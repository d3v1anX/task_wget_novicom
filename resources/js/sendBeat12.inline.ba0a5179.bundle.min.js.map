{"version":3,"file":"sendBeat12.inline.ba0a5179.bundle.min.js","mappings":"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","sources":["webpack:///./bi-head-scripts/sendBeat12.ts","webpack:///../../thunderbolt-environment/src/bi-module/isIOS.ts","webpack:///../../thunderbolt-environment/src/bi-module/sendBeacon.ts","webpack:///../../thunderbolt-environment/src/bi-module/urlBuilder.ts","webpack:///../../thunderbolt-environment/src/bi-module/isBot.ts","webpack:///../../thunderbolt-environment/src/bi-module/sessionBuilder.ts","webpack:///../../thunderbolt-environment/src/bi-module/isIFrame.ts","webpack:///../../thunderbolt-environment/src/bi-module/isSuspectedBot.ts","webpack:///../../thunderbolt-environment/src/bi-module/cachingData.ts","webpack:///./bi-module/instance.ts","webpack:///../../thunderbolt-environment/src/bi-module/biModule.ts"],"sourcesContent":["import { instance } from '../bi-module/instance'\n\ninstance.sendBeat(12, 'Partially visible', { pageId: window.firstPageId })\n","export const isIOS = (): boolean => /\\(iP(hone|ad|od);/i.test(window?.navigator?.userAgent)\n","import { isIOS } from './isIOS'\n\nexport const sendBeacon = (url: string): void => {\n\tlet sent = false\n\n\tif (!window.viewerModel?.experiments['specs.thunderbolt.checkIOSToAvoidBeacon'] || !isIOS()) {\n\t\ttry {\n\t\t\tsent = navigator.sendBeacon(url)\n\t\t} catch (e) {}\n\t}\n\tif (!sent) {\n\t\tnew Image().src = url\n\t}\n}\n","import type { WixBiSession } from '@wix/thunderbolt-symbols'\nimport type { DynamicSessionData } from './biModule'\n\nexport type BiEventParams = {\n\teventType: number\n\tts: number\n\ttts: number\n\textra?: string\n}\n\nconst OMIT_PARAM = null\n\nfunction getQueryParamBuilder([key, value]: [string, any]) {\n\treturn value !== OMIT_PARAM && `${key}=${value}`\n}\n\nfunction createExtraParamsHandler(extra: string) {\n\tconst _extra = extra.split('&').reduce((result: Record<string, string>, curr: string) => {\n\t\tconst [p, v] = curr.split('=')\n\t\treturn {\n\t\t\t...result,\n\t\t\t[p]: v,\n\t\t}\n\t}, {})\n\treturn (key: string, value: string | number | null) => (_extra[key] !== undefined ? _extra[key] : value)\n}\n\nfunction createBiSessionHandler(wixBiSession: WixBiSession) {\n\treturn <K extends keyof WixBiSession>(key: K) =>\n\t\ttypeof wixBiSession[key] === 'undefined' ? OMIT_PARAM : wixBiSession[key]\n}\n\nfunction extractCookie() {\n\tconst match = document.cookie.match(/_wixCIDX=([^;]*)/)\n\treturn match && match[1]\n}\n\nfunction removeUrlSearch(rawUrl: string | null) {\n\tif (!rawUrl) {\n\t\treturn OMIT_PARAM\n\t}\n\tconst u = new URL(decodeURIComponent(rawUrl))\n\tu.search = '?'\n\treturn encodeURIComponent(u.href)\n}\n\nfunction build(\n\teventName: string,\n\t{ eventType, ts, tts, extra = '' }: BiEventParams,\n\tsessionData: WixBiSession,\n\tdynamicSessionData?: Partial<DynamicSessionData>\n) {\n\tconst extraParamHandler = createExtraParamsHandler(extra)\n\tconst fromSession = createBiSessionHandler(sessionData)\n\tlet shouldCleanBeats = true\n\tconst cpm = window?.consentPolicyManager\n\tif (cpm) {\n\t\tconst consentPolicy = cpm.getCurrentConsentPolicy()\n\t\tif (consentPolicy) {\n\t\t\tconst { policy } = consentPolicy\n\t\t\tshouldCleanBeats = !(policy.functional && policy.analytics)\n\t\t}\n\t}\n\tconst requestUrl = fromSession('requestUrl')\n\tconst biParams = {\n\t\tsrc: '29',\n\t\tevid: '3',\n\t\tviewer_name: fromSession('viewerName'),\n\t\tcaching: fromSession('caching'),\n\t\tclient_id: shouldCleanBeats ? OMIT_PARAM : extractCookie(),\n\t\tdc: fromSession('dc'),\n\t\tmicroPop: fromSession('microPop'),\n\t\tet: eventType,\n\t\tevent_name: eventName ? encodeURIComponent(eventName) : OMIT_PARAM,\n\t\tis_cached: fromSession('isCached'),\n\t\tis_platform_loaded: fromSession('is_platform_loaded'),\n\t\tis_rollout: fromSession('is_rollout'),\n\t\tism: fromSession('isMesh'),\n\t\tisp: 0, // FIXME\n\t\tisjp: fromSession('isjp'),\n\t\tiss: fromSession('isServerSide'),\n\t\tssr_fb: fromSession('fallbackReason'),\n\t\tita: extraParamHandler('ita', sessionData.checkVisibility() ? '1' : '0'),\n\t\tmid: shouldCleanBeats ? OMIT_PARAM : dynamicSessionData?.siteMemberId || OMIT_PARAM,\n\t\tmsid: fromSession('msId'),\n\t\tpid: extraParamHandler('pid', OMIT_PARAM),\n\t\tpn: extraParamHandler('pn', '1'),\n\t\tref: document.referrer && !shouldCleanBeats ? encodeURIComponent(document.referrer) : OMIT_PARAM,\n\t\tsar: shouldCleanBeats\n\t\t\t? OMIT_PARAM\n\t\t\t: extraParamHandler('sar', screen.availWidth ? `${screen.availWidth}x${screen.availHeight}` : OMIT_PARAM),\n\t\tsessionId: shouldCleanBeats && cpm ? OMIT_PARAM : fromSession('sessionId'),\n\t\tsiterev:\n\t\t\tsessionData.siteRevision || sessionData.siteCacheRevision\n\t\t\t\t? `${sessionData.siteRevision}-${sessionData.siteCacheRevision}`\n\t\t\t\t: OMIT_PARAM,\n\t\tsr: shouldCleanBeats\n\t\t\t? OMIT_PARAM\n\t\t\t: extraParamHandler('sr', screen.width ? `${screen.width}x${screen.height}` : OMIT_PARAM),\n\t\tst: fromSession('st'),\n\t\tts,\n\t\ttts,\n\t\turl: shouldCleanBeats ? removeUrlSearch(requestUrl) : requestUrl,\n\t\tv: window?.thunderboltVersion || '0.0.0',\n\t\tvid: shouldCleanBeats ? OMIT_PARAM : dynamicSessionData?.visitorId || OMIT_PARAM,\n\t\tbsi: shouldCleanBeats ? OMIT_PARAM : dynamicSessionData?.bsi || OMIT_PARAM, // TODO: get from commonConfig\n\t\tvsi: fromSession('viewerSessionId'),\n\t\twor: shouldCleanBeats || !window.outerWidth ? OMIT_PARAM : `${window.outerWidth}x${window.outerHeight}`,\n\t\twr: shouldCleanBeats\n\t\t\t? OMIT_PARAM\n\t\t\t: extraParamHandler('wr', window.innerWidth ? `${window.innerWidth}x${window.innerHeight}` : OMIT_PARAM),\n\t\t_brandId: sessionData.commonConfig?.brand || OMIT_PARAM,\n\t\tnt: extraParamHandler('nt', OMIT_PARAM),\n\t}\n\n\tconst query: string = Object.entries(biParams).map(getQueryParamBuilder).filter(Boolean).join('&')\n\treturn `https://frog.wix.com/bt?${query}`\n}\n\nexport default build\n","export const isBot = (window: Window): '' | 'ua' => {\n\tconst { userAgent } = window.navigator\n\n\tif (/instagram.+google\\/google/i.test(userAgent)) {\n\t\treturn ''\n\t}\n\n\treturn /bot|google(?!play)|phantom|crawl|spider|headless|slurp|facebookexternal|Lighthouse|PTST|^mozilla\\/4\\.0$|^\\s*$/i.test(\n\t\tuserAgent\n\t)\n\t\t? 'ua'\n\t\t: ''\n}\n","import type { ViewerModel, WixBiSession } from '@wix/thunderbolt-symbols'\nimport { isBot } from './isBot'\nimport { isSuspectedBot } from './isSuspectedBot'\nimport { isIFrame } from './isIFrame'\nimport { extractCachingData } from './cachingData'\n\n/** copied from https://github.com/wix-private/thunderbolt/blob/917d6d1314087b4d64f2265bef50010f597b6599/packages/thunderbolt-commons/src/bi/constants.ts#L33\n * since we need bi module to run as early as possible to send the beats it cant wait for thunderbolt-commons to load.\n * */\nconst MUTING_PERCENTAGE = 90 / 100 // THE PERCENTAGE OF EVENTS THAT WILL BE MUTED\nexport const shouldMuteThunderboltEvents = ({\n\trequestUrl,\n\tinteractionSampleRatio,\n}: {\n\trequestUrl: string\n\tinteractionSampleRatio: number\n}) => {\n\tconst getSampleRatioConfig = () => (interactionSampleRatio ? 1 - interactionSampleRatio : MUTING_PERCENTAGE)\n\tconst searchParam = new URL(requestUrl).searchParams\n\tif (searchParam.has('sampleEvents')) {\n\t\treturn searchParam.get('sampleEvents') === 'true'\n\t}\n\n\treturn Math.random() < getSampleRatioConfig()\n}\n\nconst SITE_TYPES: Record<ViewerModel['site']['siteType'], WixBiSession['st']> = {\n\tWixSite: 1,\n\tUGC: 2,\n\tTemplate: 3,\n}\n\nconst isInSEO = ({ seo }: { [key: string]: any }) => (seo?.isInSEO ? 'seo' : '')\n\nexport default (): WixBiSession => {\n\tconst {\n\t\tfedops,\n\t\tviewerModel: { siteFeaturesConfigs, requestUrl, site, fleetConfig, commonConfig, interactionSampleRatio },\n\t\tclientSideRender,\n\t\tsantaRenderingError,\n\t} = window\n\n\tconst muteThunderboltEvents = shouldMuteThunderboltEvents({ requestUrl, interactionSampleRatio })\n\n\tconst btype = isBot(window) || isIFrame() || isSuspectedBot() || isInSEO(siteFeaturesConfigs)\n\n\treturn {\n\t\tsuppressbi: requestUrl.includes('suppressbi=true'),\n\t\tinitialTimestamp: window.initialTimestamps.initialTimestamp,\n\t\tinitialRequestTimestamp: window.initialTimestamps.initialRequestTimestamp,\n\t\tviewerSessionId: fedops.vsi,\n\t\tviewerName: site.appNameForBiEvents,\n\t\tsiteRevision: String(site.siteRevision),\n\t\tmsId: site.metaSiteId,\n\t\tis_rollout: fleetConfig.code === 0 || fleetConfig.code === 1 ? fleetConfig.code : null,\n\t\tis_platform_loaded: 0,\n\t\trequestUrl: encodeURIComponent(requestUrl),\n\t\tsessionId: String(site.sessionId),\n\t\tbtype,\n\t\tisjp: !!btype,\n\t\tdc: site.dc,\n\t\tsiteCacheRevision: '__siteCacheRevision__',\n\t\tcheckVisibility: (() => {\n\t\t\tlet alwaysVisible = true\n\n\t\t\tfunction checkVisibility() {\n\t\t\t\talwaysVisible = alwaysVisible && document.hidden !== true\n\t\t\t}\n\n\t\t\tdocument.addEventListener('visibilitychange', checkVisibility, { passive: true })\n\t\t\tcheckVisibility()\n\t\t\treturn () => {\n\t\t\t\tcheckVisibility()\n\t\t\t\treturn alwaysVisible\n\t\t\t}\n\t\t})(),\n\t\t...extractCachingData(document.cookie, () => performance.getEntriesByType('navigation')[0].serverTiming || []),\n\t\tisMesh: 1,\n\t\tst: SITE_TYPES[site.siteType] || 0,\n\t\tcommonConfig,\n\t\tmuteThunderboltEvents,\n\t\tisServerSide: clientSideRender ? 0 : 1,\n\t\tfallbackReason: santaRenderingError?.errorInfo,\n\t}\n}\n","export const isIFrame = (): '' | 'iframe' => {\n\ttry {\n\t\tif (window.self === window.top) {\n\t\t\treturn ''\n\t\t}\n\t} catch (e) {\n\t\t// empty\n\t}\n\treturn 'iframe'\n}\n","export const isSuspectedBot = () => {\n\tif (!Function.prototype.bind) {\n\t\treturn 'bind'\n\t}\n\n\tconst { document, navigator } = window\n\tif (!document || !navigator) {\n\t\treturn 'document'\n\t}\n\tconst { webdriver, userAgent, plugins, languages } = navigator\n\tif (webdriver) {\n\t\treturn 'webdriver'\n\t}\n\n\tif (!plugins || Array.isArray(plugins)) {\n\t\treturn 'plugins'\n\t}\n\t// Because of https://www.npmjs.com/package/puppeteer-extra-plugin-stealth\n\tif (Object.getOwnPropertyDescriptor(plugins, '0')?.writable) {\n\t\treturn 'plugins-extra'\n\t}\n\n\tif (!userAgent) {\n\t\treturn 'userAgent'\n\t}\n\tif (userAgent.indexOf('Snapchat') > 0 && document.hidden) {\n\t\treturn 'Snapchat'\n\t}\n\n\tif (!languages || languages.length === 0 || !Object.isFrozen(languages)) {\n\t\treturn 'languages'\n\t}\n\n\ttry {\n\t\t// @ts-ignore\n\t\tthrow Error()\n\t} catch (err) {\n\t\tif (err instanceof Error) {\n\t\t\tconst { stack } = err\n\t\t\tif (stack && / (\\(internal\\/)|(\\(?file:\\/)/.test(stack)) {\n\t\t\t\treturn 'stack'\n\t\t\t}\n\t\t}\n\t}\n\n\treturn ''\n}\n","import { CookieAnalysis } from '@wix/thunderbolt-symbols'\n\nexport type TimingEntry = { name: string; description: string }\n\nconst extractServerTiming = (getTimingEntries: () => Array<TimingEntry>) => {\n\tlet serverTiming: Array<any>\n\ttry {\n\t\tserverTiming = getTimingEntries()\n\t} catch (e) {\n\t\tserverTiming = []\n\t}\n\tlet microPop\n\tconst matches: Array<string> = []\n\tserverTiming.forEach((st) => {\n\t\tswitch (st.name) {\n\t\t\tcase 'cache':\n\t\t\t\tmatches[1] = st.description\n\t\t\t\tbreak\n\t\t\tcase 'varnish':\n\t\t\t\tmatches[2] = st.description\n\t\t\t\tbreak\n\t\t\tcase 'dc':\n\t\t\t\tmicroPop = st.description\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tbreak\n\t\t}\n\t})\n\treturn {\n\t\tmicroPop,\n\t\tmatches,\n\t}\n}\n\nexport const extractCachingData = (cookie: string, getTimingEntries: () => Array<TimingEntry>): CookieAnalysis => {\n\tlet microPop,\n\t\tcaching = 'none'\n\tlet match: Array<string> | null = cookie.match(\n\t\t/ssr-caching=\"?cache[,#]\\s*desc=([\\w-]+)(?:[,#]\\s*varnish=(\\w+))?(?:[,#]\\s*dc[,#]\\s*desc=([\\w-]+))?(?:\"|;|$)/\n\t)\n\tif (!match && window.PerformanceServerTiming) {\n\t\tconst results = extractServerTiming(getTimingEntries)\n\t\tmicroPop = results.microPop\n\t\tmatch = results.matches\n\t}\n\tif (match && match.length) {\n\t\tcaching = `${match[1]},${match[2] || 'none'}`\n\t\tif (!microPop) {\n\t\t\tmicroPop = match[3]\n\t\t}\n\t}\n\tif (caching === 'none') {\n\t\tconst timing = typeof performance !== 'undefined' ? performance.timing : null\n\t\tif (timing && timing.responseStart - timing.requestStart === 0) {\n\t\t\tcaching = 'browser'\n\t\t}\n\t}\n\treturn {\n\t\tcaching,\n\t\tisCached: caching.indexOf('hit') === 0,\n\t\t...(microPop ? { microPop } : {}),\n\t}\n}\n","import { BiModule } from '@wix/thunderbolt-environment'\n\nexport const instance = BiModule()\nwindow.bi = instance\nwindow.bi.wixBiSession.isServerSide = window.clientSideRender ? 0 : 1\nif (window.clientSideRender) {\n\twindow.bi.wixBiSession.fallbackReason = window.santaRenderingError?.errorInfo\n}\n/**\n *  This code runs inline in the head response. here: https://github.com/wix-private/thunderbolt/blob/fcb9b3af0b177c5520e94867e0e072050eca6f78/packages/thunderbolt-app/src/templates/main-head.ejs#L127\n */\ninstance.sendBeat(1, 'Init')\n","import { BeatEventType, InternalNavigationType, BIReporter, WixBiSession } from '@wix/thunderbolt-symbols'\nimport { sendBeacon } from './sendBeacon'\nimport urlBuilder from './urlBuilder'\nimport getBiSessionInstance from './sessionBuilder'\n\nexport type DynamicSessionData = {\n\tvisitorId: string\n\tsiteMemberId: string\n\tbsi: string\n}\n\nfunction BiModule(): BIReporter & { wixBiSession: WixBiSession; sendBeacon: (url: string) => void } {\n\tconst wixBiSession: WixBiSession = getBiSessionInstance()\n\tconst dynamicSession: Partial<DynamicSessionData> = {}\n\tlet pageNumberData: number = 1\n\n\tfunction markBeat(eventType: number, eventName?: string): void {\n\t\tif (eventName && performance.mark) {\n\t\t\tconst mark = `${eventName} (beat ${eventType})`\n\t\t\tperformance.mark(mark)\n\t\t}\n\t}\n\n\tfunction markBi(eventName: string, eventPhase?: string): void {\n\t\tconst markName = eventPhase ? `${eventName} - ${eventPhase}` : eventName\n\t\tconst prevMarkName = eventPhase === 'end' ? `${eventName} - start` : null\n\t\tperformance.mark(markName)\n\t\tif (performance.measure && prevMarkName) {\n\t\t\tperformance.measure(`\\u2B50${eventName}`, prevMarkName, markName)\n\t\t}\n\t}\n\n\tfunction reportBI(eventName: string, eventPhase?: string): void {\n\t\tmarkBi(eventName, eventPhase)\n\t}\n\n\tfunction reportPageNavigation(pageId: string | undefined): void {\n\t\tpageNumberData = pageNumberData + 1\n\n\t\tsendBeat(BeatEventType.PAGE_NAVIGATION, 'page navigation start', {\n\t\t\tpageId,\n\t\t\tpageNumber: pageNumberData,\n\t\t})\n\t}\n\n\tfunction reportPageNavigationDone(pageId: string | undefined, navigationType: InternalNavigationType): void {\n\t\tsendBeat(BeatEventType.PAGE_NAVIGATION_DONE, 'page navigation complete', {\n\t\t\tpageId,\n\t\t\tpageNumber: pageNumberData,\n\t\t\tnavigationType,\n\t\t})\n\t\tif (\n\t\t\tnavigationType === InternalNavigationType.DYNAMIC_REDIRECT ||\n\t\t\tnavigationType === InternalNavigationType.NAVIGATION_ERROR ||\n\t\t\tnavigationType === InternalNavigationType.CANCELED\n\t\t) {\n\t\t\tpageNumberData = pageNumberData - 1\n\t\t}\n\t}\n\n\tconst sendBeat: BIReporter['sendBeat'] = (eventType, eventName, options = {}) => {\n\t\tconst now = Date.now()\n\t\tconst tts = Math.round(performance.now())\n\t\tconst ts = now - wixBiSession.initialTimestamp\n\t\tmarkBeat(eventType, eventName)\n\t\tif (wixBiSession.suppressbi || window.__browser_deprecation__) {\n\t\t\treturn\n\t\t}\n\t\tconst { pageId, pageNumber = pageNumberData, navigationType } = options\n\t\tlet extra = `&pn=${pageNumber}`\n\t\tif (pageId) {\n\t\t\textra += `&pid=${pageId}`\n\t\t}\n\t\tif (navigationType) {\n\t\t\textra += `&nt=${navigationType}`\n\t\t}\n\n\t\tconst frogUrl = urlBuilder(eventName, { eventType, ts, tts, extra }, wixBiSession, dynamicSession)\n\t\tsendBeacon(frogUrl)\n\t}\n\n\tconst setDynamicSessionData = ({\n\t\tvisitorId,\n\t\tsiteMemberId,\n\t\tbsi,\n\t}: {\n\t\tvisitorId: string\n\t\tsiteMemberId: string\n\t\tbsi: string\n\t}) => {\n\t\tdynamicSession.visitorId = visitorId || dynamicSession.visitorId\n\t\tdynamicSession.siteMemberId = siteMemberId || dynamicSession.siteMemberId\n\t\tdynamicSession.bsi = bsi || dynamicSession.bsi\n\t}\n\n\treturn {\n\t\tsendBeat,\n\t\treportBI,\n\t\twixBiSession, // TODO - reanme - no more session\n\t\tsendBeacon,\n\t\tsetDynamicSessionData,\n\t\treportPageNavigation,\n\t\treportPageNavigationDone,\n\t}\n}\n\nexport { BiModule }\n"],"names":["pageId","window","firstPageId","sendBeacon","url","sent","viewerModel","experiments","test","navigator","userAgent","isIOS","e","Image","src","OMIT_PARAM","getQueryParamBuilder","key","value","extractCookie","match","document","cookie","removeUrlSearch","rawUrl","u","URL","decodeURIComponent","search","encodeURIComponent","href","eventName","eventType","ts","tts","extra","sessionData","dynamicSessionData","extraParamHandler","_extra","split","reduce","result","curr","p","v","undefined","createExtraParamsHandler","fromSession","wixBiSession","shouldCleanBeats","cpm","consentPolicyManager","consentPolicy","getCurrentConsentPolicy","policy","functional","analytics","requestUrl","biParams","evid","viewer_name","caching","client_id","dc","microPop","et","event_name","is_cached","is_platform_loaded","is_rollout","ism","isp","isjp","iss","ssr_fb","ita","checkVisibility","mid","siteMemberId","msid","pid","pn","ref","referrer","sar","screen","availWidth","availHeight","sessionId","siterev","siteRevision","siteCacheRevision","sr","width","height","st","thunderboltVersion","vid","visitorId","bsi","vsi","wor","outerWidth","outerHeight","wr","innerWidth","innerHeight","_brandId","commonConfig","brand","nt","Object","entries","map","filter","Boolean","join","SITE_TYPES","WixSite","UGC","Template","fedops","siteFeaturesConfigs","site","fleetConfig","interactionSampleRatio","clientSideRender","santaRenderingError","muteThunderboltEvents","searchParam","searchParams","has","get","Math","random","shouldMuteThunderboltEvents","btype","isBot","self","top","isIFrame","Function","prototype","bind","webdriver","plugins","languages","Array","isArray","getOwnPropertyDescriptor","writable","indexOf","hidden","length","isFrozen","Error","err","stack","isSuspectedBot","seo","isInSEO","suppressbi","includes","initialTimestamp","initialTimestamps","initialRequestTimestamp","viewerSessionId","viewerName","appNameForBiEvents","String","msId","metaSiteId","code","alwaysVisible","addEventListener","passive","getTimingEntries","PerformanceServerTiming","results","serverTiming","matches","forEach","name","description","extractServerTiming","timing","performance","responseStart","requestStart","isCached","extractCachingData","getEntriesByType","isMesh","siteType","isServerSide","fallbackReason","errorInfo","instance","dynamicSession","pageNumberData","sendBeat","options","now","Date","round","mark","markBeat","__browser_deprecation__","pageNumber","navigationType","frogUrl","urlBuilder","reportBI","eventPhase","markName","prevMarkName","measure","markBi","setDynamicSessionData","reportPageNavigation","reportPageNavigationDone","BiModule","bi"],"sourceRoot":""}